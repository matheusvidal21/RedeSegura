package br.rnp.redesegura.services.impl;

import br.rnp.redesegura.dto.ServiceCheckDto;
import br.rnp.redesegura.dto.response.VulnerabilityTestResponse;
import br.rnp.redesegura.exception.NotFoundException;
import br.rnp.redesegura.factory.VulnerabilityTestFactory;
import br.rnp.redesegura.models.Service;
import br.rnp.redesegura.models.Vulnerability;
import br.rnp.redesegura.models.VulnerabilityType;
import br.rnp.redesegura.models.enums.ServiceStatus;
import br.rnp.redesegura.models.enums.TestStatus;
import br.rnp.redesegura.models.enums.VulnerabilityStatus;
import br.rnp.redesegura.repositories.ServiceRepository;
import br.rnp.redesegura.repositories.VulnerabilityRepository;
import br.rnp.redesegura.services.ServiceEntityService;
import br.rnp.redesegura.services.VulnerabilityService;
import br.rnp.redesegura.services.VulnerabilityTestService;
import br.rnp.redesegura.strategy.VulnerabilityTestStrategy;
import br.rnp.redesegura.utils.PdfReportGenerator;
import org.springframework.beans.factory.annotation.Autowired;

@org.springframework.stereotype.Service
public class VulnerabilityTestServiceImpl implements VulnerabilityTestService {

    @Autowired
    private VulnerabilityService vulnerabilityService;

    @Autowired
    private ServiceEntityService serviceEntityService;

    @Autowired
    private ServiceRepository serviceRepository;

    @Autowired
    private VulnerabilityRepository vulnerabilityRepository;

    @Autowired
    private PdfReportGenerator pdfReportGenerator;


    @Override
    public VulnerabilityTestResponse testVulnerability(Long vulnerabilityId) {
        Vulnerability vulnerability = vulnerabilityRepository.findById(vulnerabilityId).orElseThrow(() -> new NotFoundException("Vulnerability not found"));
        Service service = serviceRepository.findById(vulnerability.getService().getId()).orElseThrow(() -> new NotFoundException("Service not found"));

        VulnerabilityTestStrategy strategy = VulnerabilityTestFactory.getStrategy(Vulnerability.VulnerabilityTypeEnum.fromName(vulnerability.getType().getName()));

        VulnerabilityTestResponse response = strategy.test(vulnerability);

        if (response.getTestStatus().equals(TestStatus.NOT_VULNERABLE)) {
            vulnerabilityService.updateVulnerabilityStatus(vulnerability.getId(), VulnerabilityStatus.RESOLVED);
            serviceEntityService.serviceStatusUpdate(service.getId(), ServiceStatus.HEALTHY);
        } else {
            vulnerabilityService.updateVulnerabilityStatus(vulnerability.getId(), VulnerabilityStatus.NOT_RESOLVED);
            serviceEntityService.serviceStatusUpdate(service.getId(), ServiceStatus.DEGRADED);
        }

        try {
            pdfReportGenerator.generatePdfReport(response);
        } catch (Exception e) {
            throw new RuntimeException("Error generating pdf report: " + e.getMessage());
        }

        return response;
    }

    @Override
    public VulnerabilityTestResponse testVulnerability(ServiceCheckDto serviceCheckDto, Vulnerability.VulnerabilityTypeEnum vulnerabilityType) {
        var service = Service.builder()
                .ip(serviceCheckDto.getIp())
                .port(serviceCheckDto.getPort())
                .build();

        var type = VulnerabilityType.builder()
                .name(vulnerabilityType.getTypeName())
                .build();

        var vulnerability = Vulnerability.builder()
                .type(type)
                .service(service)
                .build();

        VulnerabilityTestStrategy strategy = VulnerabilityTestFactory.getStrategy(vulnerabilityType);
        VulnerabilityTestResponse response = strategy.test(vulnerability);
        try {
            pdfReportGenerator.generatePdfReport(response);
        } catch (Exception e) {
            throw new RuntimeException("Error generating pdf report: " + e.getMessage());
        }
        return response;
    }


}
